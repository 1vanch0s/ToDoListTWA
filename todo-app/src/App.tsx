import React, { useState, useEffect } from "react";
import { BrowserRouter as Router, Route, Routes, NavLink } from "react-router-dom";
import Tasks from "./pages/Tasks";
import Rewards from "./pages/Rewards";
import Profile from "./pages/Profile";
import "./styles.css";

const App: React.FC = () => {
  const [coins, setCoins] = useState<number>(() => {
    const savedStats = localStorage.getItem("stats");
    return savedStats ? JSON.parse(savedStats).totalCoins || 0 : 0;
  });
  const [showRegisterPopup, setShowRegisterPopup] = useState(false);
  const [chatId, setChatId] = useState<number | null>(null);
  const [userName, setUserName] = useState<string>("");
  const [avatarUrl, setAvatarUrl] = useState<string | null>(null);

  useEffect(() => {
    const tg = (window as any).Telegram?.WebApp;
    if (!tg) {
      console.error("Telegram WebApp is not available");
      return;
    }
    tg.ready();
    const user = tg.initDataUnsafe.user;
    console.log("Telegram user data:", tg.initDataUnsafe); // –û—Ç–ª–∞–¥–∫–∞
    if (user && user.id) {
      setChatId(user.id);
      setUserName(user.first_name + (user.last_name ? " " + user.last_name : ""));
      setAvatarUrl(user.photo_url || null);
      if (!localStorage.getItem("isRegistered")) {
        setShowRegisterPopup(true);
      }
    } else {
      console.log("No user data from Telegram");
    }
  }, []);

  const registerUser = async () => {
    if (!chatId || !userName) {
      console.log("–û—à–∏–±–∫–∞: chatId –∏–ª–∏ userName –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç", { chatId, userName });
      return;
    }

    console.log("–ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", { userId: chatId.toString(), username: userName, avatarUrl });
    console.log("API URL:", process.env.REACT_APP_API_URL); // –û—Ç–ª–∞–¥–∫–∞

    try {
      const response = await fetch(`${process.env.REACT_APP_API_URL}/users`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: chatId.toString(),
          username: userName,
          avatarUrl: avatarUrl,
        }),
      });
      const responseData = await response.json(); // –ß–∏—Ç–∞–µ–º —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞
      if (response.ok) {
        console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:", responseData);
        localStorage.setItem("isRegistered", "true");
        setShowRegisterPopup(false);
      } else {
        console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", responseData.error || response.statusText);
      }
    } catch (err) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", (err as Error).message); // –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ Error
    }
  };

  const updateCoins = () => {
    const savedStats = localStorage.getItem("stats");
    const totalCoins = savedStats ? JSON.parse(savedStats).totalCoins || 0 : 0;
    setCoins(totalCoins);
  };

  return (
    <Router>
      <div>
        <header className="header">
          <div className="user-info">
            {avatarUrl ? (
              <img src={avatarUrl} alt="–ê–≤–∞—Ç–∞—Ä" className="avatar-image" />
            ) : (
              <div className="avatar"></div>
            )}
            <span>{userName}</span>
          </div>
          <div className="coins">
            <span>{coins} üí∞</span>
          </div>
        </header>
        <nav className="nav">
          <NavLink to="/" className={({ isActive }) => isActive ? "nav-button active" : "nav-button"}>
            –ó–∞–¥–∞—á–∏
          </NavLink>
          <NavLink to="/rewards" className={({ isActive }) => isActive ? "nav-button active" : "nav-button"}>
            –ù–∞–≥—Ä–∞–¥—ã
          </NavLink>
          <NavLink to="/profile" className={({ isActive }) => isActive ? "nav-button active" : "nav-button"}>
            –ü—Ä–æ—Ñ–∏–ª—å
          </NavLink>
        </nav>
        <Routes>
          <Route path="/" element={<Tasks updateCoins={updateCoins} />} />
          <Route path="/profile" element={<Profile />} />
          <Route path="/rewards" element={<Rewards updateCoins={updateCoins} />} />
        </Routes>

        {showRegisterPopup && (
          <div className="popup">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <p>–†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∞—à–µ –∏–º—è –∏ –∞–≤–∞—Ç–∞—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏?</p>
            <p>–ò–º—è: {userName}</p>
            {avatarUrl && <img src={avatarUrl} alt="–ê–≤–∞—Ç–∞—Ä" style={{ width: "50px", height: "50px" }} />}
            <button onClick={registerUser} className="button primary-button">
              –†–∞–∑—Ä–µ—à–∏—Ç—å
            </button>
            <button onClick={() => setShowRegisterPopup(false)} className="button close-button">
              –û—Ç–º–µ–Ω–∞
            </button>
          </div>
        )}
      </div>
    </Router>
  );
};

export default App;